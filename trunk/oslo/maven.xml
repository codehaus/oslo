<project
    xmlns:m="maven"
    xmlns:jxr="jxr"
    xmlns:j="jelly:core"
    xmlns:u="jelly:util"
    xmlns:maven="jelly:maven"
    xmlns:ant="jelly:ant">

    <property name="aspectwerkz.classpath" refid="maven.dependency.classpath"/>

    <property environment="env"/>

    <!--    <taskdef name="compileSourceMetaData"
            classname="aspectwerkz.definition.metadata.task.SourceFileMetaDataCompilerTask"
            classpath="${aspectwerkz.classpath}"/>

        <taskdef name="compileClassMetaData"
            classname="aspectwerkz.definition.metadata.task.ClassFileMetaDataCompilerTask"
            classpath="${aspectwerkz.classpath}"/>-->
    <echo>${aspectwerkz.classpath}</echo>

    <ant:taskdef name="offlineTransformation"
        classname="org.codehaus.aspectwerkz.task.OfflineTransformationTask"
        classpath="${aspectwerkz.classpath}"/>

    <!--    <ant:taskdef name="schemaexport"
            classname="net.sf.hibernate.tool.hbm2ddl.SchemaExportTask"
            classpath="${aspectwerkz.classpath}"/>-->
    <!--<taskdef name="compileWeaveModelFromClasses"
        classname="org.codehaus.aspectwerkz.task.ClassFileMetaDataCompilerTask"
        classpath="${aspectwerkz.classpath}"/>-->

    <!--<goal name="createdatabase" prereqs="xdoclet:hibernatedoclet">
        <ant:taskdef name="schemaexport"
            classname="net.sf.hibernate.tool.hbm2ddl.SchemaExportTask"
            classpath="${aspectwerkz.classpath}:${maven.build.dir}/classes"/>
            -->
        <!-- Export the schema to the database -->
<!--        <schemaexport
            properties="${maven.src.dir}/config/hibernate.properties"
            quiet="no"
            text="no"
            delimiter=";"
            output="${maven.build.dir}/schema/${maven.final.name}-schema.sql">
            <fileset dir="${maven.build.dir}/classes">
                <include name="**/*.hbm.xml"/>
            </fileset>
        </schemaexport>
    </goal>-->

    <goal name="build-all" description="Build all components using reactor">
        <maven:reactor
            basedir="${basedir}"
            includes="*/project.xml"
            goals="default"
            banner="Building"
            ignoreFailures="false"/>
    </goal>


    <!-- =================================================== -->
    <!--  Compile the classes with AspectWerkz               -->
    <!-- =================================================== -->
    <goal name="oslo:aspectwerkz:preprocess" prereqs="java:compile">
        <echo>${maven.src.dir}/aspectwerkz/oslo.xml</echo>
        <echo>${aspectwerkz.classpath}</echo>
        <echo>${maven.build.dir}/classes</echo>
        <echo>aspectwerkz.home=${env.ASPECTWERKZ_HOME}</echo>

        <!--    <compileClassMetaData
                definitionFile="${maven.src.dir}/aspectwerkz/oslo.xml"
                repository="${maven.build.dir}/classes"
                metaDataDir="${maven.build.dir}/_metaData"/>   -->

        <!-- Create the meta-data directory -->
        <mkdir dir="${maven.build.dir}/_metaData"/>

        <!--<compileWeaveModelFromClasses
            definitionFile="${maven.src.dir}/aspectwerkz/oslo.xml"
            repository="${maven.build.dir}/classes"
            metaDataDir="${maven.build.dir}/_metaData"/>-->
        <!-- Create the meta data weave -->
        <java classname="org.codehaus.aspectwerkz.definition.metadata.ClassFileMetaDataCompiler" fork="true" classpathref="maven.dependency.classpath" output="java.output">
            <arg value="${maven.src.dir}/aspectwerkz/oslo.xml"/>
            <arg value="${maven.build.dir}/classes"/>
            <arg value="${maven.build.dir}/_metaData"/>
        </java>


        <!-- Preprocess the class files -->
        <path id="aspectwerkz.fixed.classpath">
            <pathelement path="${basedir}/devlib/bcel/jars/bcel.jar"/>
            <path refid="maven.dependency.classpath"/>
        </path>

        <java classname="org.cs3.jmangler.offline.starter.Main" classpathref="aspectwerkz.fixed.classpath" fork="true" append="true" output="java.output">
            <jvmarg value="-Daspectwerkz.definition.file=${maven.src.dir}/aspectwerkz/oslo.xml"/>
            <jvmarg value="-Daspectwerkz.src.dir="/>
            <jvmarg value="-Daspectwerkz.home=${maven.src.dir}"/>
            <jvmarg value="-Daspectwerkz.metadata.dir=${maven.build.dir}/_metaData"/>
            <jvmarg value="-Dorg.cs3.jmangler.initfile=${maven.src.dir}/config/jmangler-order.config"/>
            <arg value="--cp"/>
            <arg value="${maven.build.dir}/classes"/>
            <arg value="--tcp"/>
            <arg value="${basedir}/devlib/aspectwerkz/jars/aspectwerkz-0.5.jar"/>
            <arg value="--cf"/>
            <arg value="${maven.src.dir}/config/aspectwerkz.conf"/>
        </java>


        <!--<offlineTransformation
            aspectWerkzHome="${env.ASPECTWERKZ_HOME}"
            definitionFile="${maven.src.dir}/aspectwerkz/oslo.xml"
            classesDir="${maven.build.dir}/classes"
            metaDataDir="${maven.build.dir}/_metaData"/>-->

        <!-- Load the output and display it -->
        <loadfile property="message" srcFile="java.output"/>
        <echo>${message}</echo>
    </goal>

    <goal name="oslo:execute:sample"> <!--prereqs="oslo:aspectwerkz:preprocess">-->
        <!-- ClassPath for the sample file -->
        <path id="execute.path">
            <pathelement path="${basedir}/devlib/bcel/jars/bcel.jar"/>
            <path refid="maven.dependency.classpath"/>
            <pathelement path="${maven.build.dir}/classes"/>
        </path>

        <!-- Execute the sample class with or without the aspects -->
        <java classname="org.oslo.sampleapp.SampleMain" fork="true" classpathref="execute.path" output="java.output">
            <jvmarg value="-Daspectwerkz.definition.file=${maven.src.dir}/aspectwerkz/oslo.xml"/>
            <jvmarg value="-Daspectwerkz.home=${basedir}"/>
            <jvmarg value="-Daspectwerkz.metadata.dir=${maven.build.dir}/_metaData"/>
        </java>

        <!-- Load the output and display it -->
        <loadfile property="message" srcFile="java.output"/>
        <echo>${message}</echo>
    </goal>

    <goal name="oslo:execute:console">
        <!--
           Seems to be a problem with ant and reflection, use run-console.sh
           to start the console
        -->

        <!-- ClassPath for the sample file -->
        <!--<path id="execute.path">
            <pathelement path="${basedir}/devlib/bcel/jars/bcel.jar"/>
            <path refid="maven.dependency.classpath"/>
            <pathelement path="${maven.build.dir}/classes"/>
        </path>

        <property name="cp" refid="execute.path"/>
        <echo>${cp}</echo> -->

        <!-- Execute the sample class with or without the aspects -->
        <!--<java classname="org.oslo.cli.CommandLine" fork="true" classpathref="execute.path" />-->
    </goal>

    <goal name="oslo:start:server" prereqs="oslo:cleanup, oslo:aspectwerkz:preprocess">
        <!-- ClassPath for the sample file -->
        <path id="execute.path">
            <pathelement path="${basedir}/devlib/bcel/jars/bcel.jar"/>
            <path refid="maven.dependency.classpath"/>
            <pathelement path="${maven.build.dir}/classes"/>
            <pathelement path="${maven.src.dir}/properties"/>
        </path>

        <java classname="org.oslo.server.RantLoggingServer" fork="true" classpathref="execute.path" output="server.java.output"/>

        <!-- Load the output and display it -->
        <loadfile property="message" srcFile="java.output"/>
        <echo>${message}</echo>
    </goal>

    <goal name="oslo:cleanup">
        <delete quiet="true" dir="${maven.build.dir}"/>
        <delete quiet="true" file="java.output"/>
        <delete quiet="true" file="server.java.output"/>
        <delete quiet="true">
            <fileset dir="./database" includes="**/*"/>
        </delete>
    </goal>

    <goal name="oslo:execute:sequence-gui">
        <java classname="com.zanthan.sequence.Main" fork="true" classpathref="maven.dependency.classpath" output="java.output"/>
    </goal>
</project>